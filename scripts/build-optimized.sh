#!/bin/bash

# =============================================================================
# –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å–±–æ—Ä–∫–∞ FRDA —Å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º Docker —Å–ª–æ–µ–≤
# =============================================================================

set -e

echo "üöÄ –ó–∞–ø—É—Å–∫ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å–±–æ—Ä–∫–∏ FRDA..."

# –í–∫–ª—é—á–∞–µ–º —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ Docker –¥–ª—è –ª—É—á—à–µ–≥–æ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
export DOCKER_BUILDKIT=1
export COMPOSE_DOCKER_CLI_BUILD=1

# =============================================================================
# –≠–¢–ê–ü 1: –°–±–æ—Ä–∫–∞ –±–∞–∑–æ–≤–æ–≥–æ –æ–±—Ä–∞–∑–∞ —Å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏ (–∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ)
# =============================================================================

echo "üì¶ –°–±–æ—Ä–∫–∞ –±–∞–∑–æ–≤–æ–≥–æ –æ–±—Ä–∞–∑–∞ —Å Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏..."

# –°–±–æ—Ä–∫–∞ —Ç–æ–ª—å–∫–æ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
docker build \
    --target dependencies \
    --tag frda-worker-deps:latest \
    --file worker/Dockerfile \
    --build-arg BUILDKIT_INLINE_CACHE=1 \
    .

echo "‚úÖ –ë–∞–∑–æ–≤—ã–π –æ–±—Ä–∞–∑ —Å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏ –≥–æ—Ç–æ–≤ –∏ –∑–∞–∫–µ—à–∏—Ä–æ–≤–∞–Ω"

# =============================================================================
# –≠–¢–ê–ü 2: –°–±–æ—Ä–∫–∞ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ–±—Ä–∞–∑–∞ —Å –∫–æ–¥–æ–º
# =============================================================================

echo "üîß –°–±–æ—Ä–∫–∞ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ–±—Ä–∞–∑–∞..."

# –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–µ—à –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —ç—Ç–∞–ø–∞
docker-compose build \
    --build-arg BUILDKIT_INLINE_CACHE=1 \
    cpu-worker

echo "‚úÖ CPU Worker —Å–æ–±—Ä–∞–Ω —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∫–µ—à–∞"

# =============================================================================
# –≠–¢–ê–ü 3: –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ - —Å–±–æ—Ä–∫–∞ GPU Worker
# =============================================================================

if [ "$1" = "--with-gpu" ]; then
    echo "üéÆ –°–±–æ—Ä–∫–∞ GPU Worker..."
    docker-compose build \
        --build-arg BUILDKIT_INLINE_CACHE=1 \
        gpu-worker
    echo "‚úÖ GPU Worker —Å–æ–±—Ä–∞–Ω"
fi

# =============================================================================
# –≠–¢–ê–ü 4: –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
# =============================================================================

echo "üöÄ –ó–∞–ø—É—Å–∫ FRDA –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã..."

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)
docker-compose down --remove-orphans

# –ó–∞–ø—É—Å–∫–∞–µ–º –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ
docker-compose up -d

echo "‚úÖ FRDA –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –∑–∞–ø—É—â–µ–Ω–∞!"

# –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–æ–≤
echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–æ–≤..."
sleep 10

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
echo "üìä –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤:"
docker-compose ps

# =============================================================================
# –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –†–ï–ó–£–õ–¨–¢–ê–¢–ï
# =============================================================================

echo ""
echo "üéØ –°–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫ –∑–∞–≤–µ—Ä—à–µ–Ω—ã!"
echo ""
echo "üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–∏:"
echo "   ‚Ä¢ Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∑–∞–∫–µ—à–∏—Ä–æ–≤–∞–Ω—ã –≤ –æ–±—Ä–∞–∑–µ: frda-worker-deps:latest"
echo "   ‚Ä¢ –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–æ–ª—å–∫–æ –∫–æ–¥–∞ PyTorch –Ω–µ –±—É–¥–µ—Ç –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å—Å—è"
echo "   ‚Ä¢ –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ requirements.txt –∫–µ—à –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω"
echo ""
echo "üåê –î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã:"
echo "   ‚Ä¢ FastAPI: http://localhost:7777"
echo "   ‚Ä¢ MinIO Console: http://localhost:9001 (minioadmin/minioadmin)"
echo "   ‚Ä¢ PostgreSQL: localhost:5432 (postgres/password)"
echo "   ‚Ä¢ Redis: localhost:6379"
echo ""
echo "üîÑ –°–ª–µ–¥—É—é—â–∏–µ —Å–±–æ—Ä–∫–∏ –±—É–¥—É—Ç –Ω–∞–º–Ω–æ–≥–æ –±—ã—Å—Ç—Ä–µ–µ!"
echo ""
echo "üí° –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
echo "   docker-compose logs -f        # –õ–æ–≥–∏ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤"
echo "   docker-compose logs cpu-worker # –õ–æ–≥–∏ worker'–∞"
echo "   docker-compose down            # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã"
echo "   docker images | grep frda      # –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ–±—Ä–∞–∑—ã"
echo "   docker system df               # –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–µ—Å—Ç–∞"
echo "" 