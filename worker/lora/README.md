# LoRA Fine-tuning Module

## –û–±–∑–æ—Ä

–ú–æ–¥—É–ª—å `worker/lora/` –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –¥–æ–æ–±—É—á–µ–Ω–∏–µ LoRA-–∞–¥–∞–ø—Ç–µ—Ä–æ–≤ —è–∑—ã–∫–æ–≤—ã—Ö –º–æ–¥–µ–ª–µ–π —Å –±–∞–π–µ—Å–æ–≤—Å–∫–æ–π –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π –≥–∏–ø–µ—Ä–ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–π –æ—Ü–µ–Ω–∫–æ–π –∫–∞—á–µ—Å—Ç–≤–∞.

## –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 1. `lora_tuning.py`
–û—Å–Ω–æ–≤–Ω–æ–π –º–æ–¥—É–ª—å —Å –∫–ª–∞—Å—Å–æ–º `LoRATuner` –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –¥–æ–æ–±—É—á–µ–Ω–∏—è.

### 2. `bayesian_optimizer.py` 
–ë–∞–π–µ—Å–æ–≤—Å–∫–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –≥–∏–ø–µ—Ä–ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ LoRA —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Optuna.

### 3. `evaluation.py`
–°–∏—Å—Ç–µ–º–∞ –æ—Ü–µ–Ω–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –º–æ–¥–µ–ª–µ–π —á–µ—Ä–µ–∑:
- **BERTScore**: –ë—ã—Å—Ç—Ä–∞—è —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∞—è –æ—Ü–µ–Ω–∫–∞
- **LLM Judge**: –ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è –æ—Ü–µ–Ω–∫–∞ —á–µ—Ä–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é —è–∑—ã–∫–æ–≤—É—é –º–æ–¥–µ–ª—å

### 4. `lora_tuning_config.py`
–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –¥–æ–æ–±—É—á–µ–Ω–∏—è.

## –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å: –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π LLM Judge

### –ß—Ç–æ —Ç–∞–∫–æ–µ LLM Judge?

LLM Judge ‚Äî —ç—Ç–æ —Å–∏—Å—Ç–µ–º–∞ –æ—Ü–µ–Ω–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –æ–±—É—á–µ–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏ —Å –ø–æ–º–æ—â—å—é –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π —è–∑—ã–∫–æ–≤–æ–π –º–æ–¥–µ–ª–∏. –û–Ω–∞ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∫–∞—á–µ—Å—Ç–≤–æ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –±–æ–ª–µ–µ –≤—ã—Å–æ–∫–æ–º —É—Ä–æ–≤–Ω–µ, —á–µ–º –ø—Ä–æ—Å—Ç—ã–µ –º–µ—Ç—Ä–∏–∫–∏.

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ LLM Judge:
- üéØ **–ë–æ–ª–µ–µ —Ç–æ—á–Ω–∞—è –æ—Ü–µ–Ω–∫–∞**: –£—á–∏—Ç—ã–≤–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ —Å–µ–º–∞–Ω—Ç–∏–∫—É
- üß† **–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞**: –ü–æ–Ω–∏–º–∞–µ—Ç —Å—Ç–∏–ª—å –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∑–∞–¥–∞—á–µ
- üìä **–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏**: BERTScore (40%) + LLM Judge (60%)

### –ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏ LLM Judge:
- ‚è∞ **–£–≤–µ–ª–∏—á–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è**: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ API-–≤—ã–∑–æ–≤—ã
- üí∞ **–ü–æ–≤—ã—à–µ–Ω–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤–Ω–µ—à–Ω–∏—Ö LLM API
- üîÑ **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å**: –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –≤–Ω–µ—à–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —á–µ—Ä–µ–∑ API

### –ó–∞–ø—Ä–æ—Å —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ LLM Judge:

```json
{
  "project_id": 123,
  "fine_tuning_params": {
    "use_llm_judge": true,
    "judge_model_id": "gemini",
    "base_model_name": "Qwen/Qwen3-0.6B",
    "n_trials": 20
  }
}
```

### –ó–∞–ø—Ä–æ—Å –ë–ï–ó LLM Judge:

```json
{
  "project_id": 123,
  "fine_tuning_params": {
    "use_llm_judge": false,
    "base_model_name": "Qwen/Qwen3-0.6B",
    "n_trials": 15
  }
}
```

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å

–í –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã –¥–≤–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –∑–∞–ø—É—Å–∫–∞ fine-tuning:

### 1. üî• –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Fine-tuning
–û—Ç–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –æ–ø—Ü–∏—è–º–∏:
- ‚úÖ **–í–∫–ª—é—á–∏—Ç—å LLM Judge** (—á–µ–∫–±–æ–∫—Å)
- ü§ñ **–ú–æ–¥–µ–ª—å –¥–ª—è LLM Judge** (–≤—ã–±–æ—Ä –∏–∑ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö)
- üéØ **–ë–∞–∑–æ–≤–∞—è –º–æ–¥–µ–ª—å** (HuggingFace –Ω–∞–∑–≤–∞–Ω–∏–µ)
- üîÑ **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏** (5-100)

### 2. ‚ö° –ë—ã—Å—Ç—Ä—ã–π –∑–∞–ø—É—Å–∫
–ó–∞–ø—É—Å–∫–∞–µ—Ç —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:
- LLM Judge: –≤–∫–ª—é—á–µ–Ω
- –ú–æ–¥–µ–ª—å Judge: –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
- –ü–æ–ø—ã—Ç–∫–∏: 20

## –õ–æ–≥–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ü—Ä–∏–º–µ—Ä—ã –ª–æ–≥–æ–≤ —Å LLM Judge:
```
INFO - LLM Judge –≤–∫–ª—é—á–µ–Ω —Å –º–æ–¥–µ–ª—å—é: gemini
INFO - Trial 5: params={'rank': 32, 'lora_alpha': 64}, BERTScore=0.8234
INFO - LLM Judge —Å—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞: 78.50 (–Ω–∞ 5 –ø—Ä–∏–º–µ—Ä–∞—Ö)
INFO - –î–µ—Ç–∞–ª—å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞: BERTScore=0.8234, LLM Judge=78.50, Combined=0.8004
```

### –ü—Ä–∏–º–µ—Ä—ã –ª–æ–≥–æ–≤ –ë–ï–ó LLM Judge:
```
INFO - LLM Judge –≤—ã–∫–ª—é—á–µ–Ω, –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —Ç–æ–ª—å–∫–æ BERTScore
INFO - Trial 5: params={'rank': 32, 'lora_alpha': 64}, BERTScore=0.8234
INFO - –î–µ—Ç–∞–ª—å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ (–±–µ–∑ LLM Judge): BERTScore=0.8234
```

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

### –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å LLM Judge:
- üéØ **–í—ã—Å–æ–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –∫–∞—á–µ—Å—Ç–≤—É**
- üí∞ **–î–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–π –±—é–¥–∂–µ—Ç** –Ω–∞ API-–≤—ã–∑–æ–≤—ã
- ‚è∞ **–ù–µ—Ç –∂–µ—Å—Ç–∫–∏—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –ø–æ –≤—Ä–µ–º–µ–Ω–∏**
- üé® **–í–∞–∂–Ω–∞ –æ—Ü–µ–Ω–∫–∞ —Å—Ç–∏–ª—è –∏ –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç–∏**

### –ö–æ–≥–¥–∞ –ù–ï –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å LLM Judge:
- ‚ö° **–ë—ã—Å—Ç—Ä–æ–µ –ø—Ä–æ—Ç–æ—Ç–∏–ø–∏—Ä–æ–≤–∞–Ω–∏–µ**
- üí∏ **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π –±—é–¥–∂–µ—Ç**
- üîí **–°—Ç—Ä–æ–≥–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏**
- üìä **–ü—Ä–æ—Å—Ç—ã–µ –∑–∞–¥–∞—á–∏ (–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è, etc.)**

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
```bash
# –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ LoRA
LORA_MODEL_NAME=Qwen/Qwen3-0.6B
LORA_N_TRIALS=20

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±—É—á–µ–Ω–∏—è
LORA_NUM_EPOCHS=3
LORA_BATCH_SIZE=4
LORA_LEARNING_RATE=0.0001
```

### –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –º–æ–¥–µ–ª–∏ –¥–ª—è LLM Judge:
- `gemini` (Google Gemini)
- `gigachat` (–°–±–µ—Ä GigaChat)
- –õ—é–±—ã–µ –¥—Ä—É–≥–∏–µ, –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤ `shared.llm`

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –æ—Ü–µ–Ω–∫–∏

```
Validation Data ‚Üí Model Predictions
                       ‚Üì
               ‚îå‚îÄ‚îÄ‚îÄ BERTScore (–±—ã—Å—Ç—Ä–æ)
               ‚îÇ
               ‚îî‚îÄ‚îÄ‚îÄ LLM Judge (—Ç–æ—á–Ω–æ, –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω)
                       ‚Üì
               Combined Score (—Ñ–∏–Ω–∞–ª—å–Ω–∞—è –º–µ—Ç—Ä–∏–∫–∞)
```

### –§–æ—Ä–º—É–ª–∞ –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –º–µ—Ç—Ä–∏–∫–∏:
- **–° LLM Judge**: `Combined = BERTScore * 0.4 + LLMJudge * 0.6`
- **–ë–µ–∑ LLM Judge**: `Combined = BERTScore * 1.0`

## Troubleshooting

### –û—à–∏–±–∫–∞ "LLM Judge –º–æ–¥–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞":
```python
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–¥–µ–ª–∏:
from shared.llm import get_model_by_id
model = get_model_by_id("your_model_id")
```

### –í—ã—Å–æ–∫–æ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:
- –£–º–µ–Ω—å—à–∏—Ç–µ `n_trials`
- –û—Ç–∫–ª—é—á–∏—Ç–µ LLM Judge
- –£–º–µ–Ω—å—à–∏—Ç–µ —Ä–∞–∑–º–µ—Ä validation –≤—ã–±–æ—Ä–∫–∏

### –ù–∏–∑–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –±–µ–∑ LLM Judge:
- –£–≤–µ–ª–∏—á—å—Ç–µ `n_trials`
- –í–∫–ª—é—á–∏—Ç–µ LLM Judge
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–∞—á–µ—Å—Ç–≤–æ –¥–∞—Ç–∞—Å–µ—Ç–∞ 